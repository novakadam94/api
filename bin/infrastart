#!/usr/bin/env python

# Copyright (C) 2015 MTA SZTAKI

"""
This script starts an infrastructure using OCCO.

Author: adam.visegradi@sztaki.mta.hu
"""

import occo.api.occoapp as occoapp

def setup_args(cfg):
    cfg.add_argument('infra_def', occoapp.yaml_file)
occoapp.setup(setup_args)

import logging
log = logging.getLogger('occo')

#
## Load infrastructure description
#
infra_description = occoapp.args.infra_def
log.debug('Infrastructure description:\n%r', infra_description)

from occo.compiler import StaticDescription
from occo.enactor import Enactor
# TODO: The following is only needed until the Enactor has been updated to use
#       the main_info_broker instance.
from occo.infobroker import main_info_broker

occo_infrastructure = occoapp.infrastructure

uds = occo_infrastructure['uds']
compiled_infrastructure = StaticDescription(infra_description)
uds.add_infrastructure(compiled_infrastructure)

infraprocessor = occo_infrastructure['infraprocessor']
enactor = Enactor(compiled_infrastructure.infra_id,
                  main_info_broker,
                  infraprocessor)

enactor.make_a_pass()
